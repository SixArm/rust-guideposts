#!/bin/sh
set -euf

##
# Copy topic markdown files to book markdown file
#
# Parse the README.md file into markdown link URLs.
# Copy each topic markdown file into one book markdown file.
# The result is one big markdown file, suitable for pandoc.
##

TOP=$(git rev-parse --show-toplevel)

input="book.yml"
output="book.md"
cp "$input" "$output"

fold_file(){
    {
        printf \\n;
        cat "$TOP/$1/index.md"
        printf \\n;
    }
}

<"$TOP/README.md" markdown-text-to-link-urls |
grep '^doc/' |
while read -r x; do
    fold_file "$x" >> "$output"
done

# Convert Markdown headlines so they work with PDF TOC.
#
#   * ## to ### (so the TOC doesn't use it)
#   * # to ## (so the TOC shows a typical dot dot dot line)
#   * # **Headline** to # (so the TOC shows a section entry)
#
sed -i.bak 's/^## /### /; s/^# /## /; s/^## \*\*\(.*\)\*\*$/# \1/' "$output" && rm "$output.bak"


# Convert project links so pandoc doesn't make them footnotes.
#
# ## Runnable project items
#
# Input looks like:
#
#    [Runnable project](/projects/crates/foo/hello_world)
#
# Output should look like:
#
#    Runnable code in /projects/crates/foo/hello_world
#
# ## Unsorted list items
#
# Input looks like:
#
#    * [foo/hello_world](/projects/crates/foo/hello_world)
#
# Output should look like:
#
#   * `/projects/crates/foo/hello_world`
#
sed -i.bak 's#^[Runnable project](\(/projects/.*\))#Runnable code in \1#g' "$output" && rm "$output.bak"
sed -i.bak 's#^\* \[.*\](\(/projects/.*\))#* \1#g' "$output" && rm "$output.bak"
